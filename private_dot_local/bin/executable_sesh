#!/bin/bash

if [[ $# -eq 1 ]]; then
    selected=$1
else
    selected=$(
        (

            ### Add SSH hosts into fzf menu
            if [[ -f ~/.ssh/config ]]; then
                awk '
                    $1 == "Host" && NF > 1 {
                        for (i = 2; i <= NF; i++)
                            print "ssh://" $i
                    }
                ' ~/.ssh/config
            fi


            for dir in ~/Developer/github ~/Developer/igalia ~/projects ~/Developer/nvim_proj ; do
                if test -d "$dir"; then
                    # Only find directories, no recursion into subdirectories
                    find "$dir" -maxdepth 1 -mindepth 1 -type d
                fi
            done

            # Check individual files and directories exist before echoing
            for path in \
                ~/.local/bin/cadd \
                ~/.local/bin/cinstall \
                ~/.local/bin/cap \
                ~/.local/bin/cpush \
                ~/.local/bin/sesh \
                ~/.local/bin/git_investigate \
                ~/.local/share/chezmoi \
                ~/.local/bin/yabai_reload \
                ~/.local/bin/run_wasm_test_suite.py \
                ~/.zshrc \
                ~/.ccache/ccache.conf \
                ~/.tmux.conf \
                ~/.config/tmux/switch-recent-session.sh \
                ~/.lldbinit \
                ~/.gitconfig \
                ~/.gitconfig-work \
                ~/.config/nvim \
                ~/.config/kitty/kitty.conf \
                ~/.config/hypr/hyprland.conf \
                ~/.config/skhd/skhdrc \
                ~/.config/yabai/yabairc; do
                if test -e "$path"; then
                    echo "$path"
                fi
            done

        ) | fzf 
    )
fi

if test -z "$selected"; then
    exit 0
fi

selected_name=$(basename "$selected" | tr . _)
tmux_running=$(pgrep tmux)


# Start tmux if it is not running
if test -z "$tmux_running"; then
    tmux new-session -d
    tmux_running=$(pgrep tmux)
fi

if ! tmux has-session -t="$selected_name" 2>/dev/null; then
    tmux new-session -d -s "$selected_name" -c "$selected"

 ###############################################
    # SSH "DIRECTORY" MODE (3 pane remote layout)
    ###############################################
    if [[ $selected == ssh://* ]]; then
        host="${selected#ssh://}"

        # Pane 0 = remote nvim
        tmux send-keys -t "$selected_name".0 "ssh $host" C-j
        tmux send-keys -t "$selected_name".0 "nvim ." C-j

        # Create window with panes
        tmux new-window -t "$selected_name" -n "remote" "ssh $host"
        tmux split-window -h -t "$selected_name:remote" "ssh $host"
        tmux split-window -v -t "$selected_name:remote.1" "ssh $host"

        # Right-top: git status
        tmux send-keys -t "$selected_name:remote.1" "git status" C-j

        # Right-bottom: ls
        tmux send-keys -t "$selected_name:remote.2" "ls" C-j

        tmux select-pane -t "$selected_name:remote.0"
        exit_code=0
    ###############################################
    # FILE MODE
    ###############################################
    elif [[ -f $selected ]]; then
        dir=$(dirname "$selected")
        tmux send-keys -t "$selected_name" "cd \"$dir\" && nvim \"$selected\"" C-j
    ###############################################
    # DIRECTORY MODE (local)
    ###############################################
    elif [[ -d $selected ]]; then
        tmux send-keys -t "$selected_name" "cd \"$selected\"" C-j

        tmux new-window -t "$selected_name" -c "$selected" -n "dev"
        tmux split-window -h -c "$selected" -t "$selected_name:dev" -l 33%
        tmux split-window -v -c "$selected" -t "$selected_name:dev.1"

        tmux select-pane -t "$selected_name:dev.0"

        tmux send-keys -t "$selected_name:dev.1" "git status" C-j
        tmux send-keys -t "$selected_name:dev.2" "ls" C-j
        tmux send-keys -t "$selected_name:dev.0" "nvim ." C-j
    fi
fi



### -------------------------------------
###  ATTACH / SWITCH
### -------------------------------------
# Check if we have active clients when inside tmux
if test -z "$TMUX" || test -z "$(tmux list-clients)"; then
    tmux attach-session -t "$selected_name"
else
    tmux switch-client -t "$selected_name"
fi
